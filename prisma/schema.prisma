// Prisma Schema for AI Influencer Photo Pipeline
// Database: PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Comptes Instagram à scraper
model Source {
  id        String        @id @default(cuid())
  username  String        @unique // Nom d'utilisateur Instagram
  isActive  Boolean       @default(true) // Actif ou non pour le scraping
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  photos    SourcePhoto[] // Photos scrapées depuis ce compte
}

// Photos scrapées depuis Instagram
model SourcePhoto {
  id                   String           @id @default(cuid())
  sourceId             String           // Référence au compte source
  source               Source           @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  originalUrl          String           // URL originale de la photo Instagram
  localPath            String?          // Chemin local après téléchargement
  status               String           @default("pending") // pending | approved | rejected
  description          String?          // Description courte (legacy)
  generatedPrompt      String?          // Prompt complet généré par Google AI Gemini
  instagramPostUrl     String?          // URL du post Instagram original
  instagramPublishedAt DateTime?        // Date de publication sur Instagram

  // Champs pour les carrousels Instagram
  isCarousel       Boolean          @default(false) // true si fait partie d'un carrousel
  carouselId       String?          // ID unique pour regrouper les images du même carrousel
  carouselIndex    Int?             // Position dans le carrousel (0, 1, 2...)
  carouselTotal    Int?             // Nombre total d'images dans le carrousel

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  generatedPhotos  GeneratedPhoto[] // Photos générées à partir de cette source

  @@unique([instagramPostUrl, carouselIndex]) // Éviter les doublons (même post + même index)
  @@index([status])
  @@index([sourceId])
  @@index([carouselId])
  @@index([instagramPublishedAt])
}

// Photos générées via Gemini 3 Pro Image ou Wavespeed
model GeneratedPhoto {
  id            String      @id @default(cuid())
  sourcePhotoId String      // Référence à la photo source
  sourcePhoto   SourcePhoto @relation(fields: [sourcePhotoId], references: [id], onDelete: Cascade)
  prompt        String      // Prompt utilisé pour la génération
  localPath     String?     // Chemin local (legacy, non utilisé sur Vercel)
  imageData     String?     // Image en base64 (stockage cloud-compatible)

  // Champs pour les carrousels générés
  isCarousel    Boolean     @default(false) // true si fait partie d'un carrousel généré
  carouselId    String?     // ID unique pour regrouper les images générées du même carrousel
  carouselIndex Int?        // Position dans le carrousel (0, 1, 2...)
  carouselTotal Int?        // Nombre total d'images dans le carrousel

  createdAt     DateTime    @default(now())

  @@index([sourcePhotoId])
  @@index([carouselId])
}

// Configuration clé/valeur pour les paramètres de l'application
model Settings {
  id        String   @id @default(cuid())
  key       String   @unique // Clé du paramètre (ex: "apify_api_key")
  value     String   // Valeur du paramètre
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Images uploadées pour génération vidéo (Veo 3.1)
model VideoSource {
  id              String           @id @default(cuid())
  originalName    String           // Nom du fichier original
  imageData       String           // Image en base64
  mimeType        String           // image/jpeg ou image/png
  createdAt       DateTime         @default(now())
  generatedVideos GeneratedVideo[] // Vidéos générées à partir de cette image
}

// Vidéos générées via Veo 3.1 (Vertex AI)
model GeneratedVideo {
  id           String      @id @default(cuid())
  sourceId     String      // Référence à l'image source
  source       VideoSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  prompt       String?     // Prompt optionnel pour guider la génération
  aspectRatio  String      @default("9:16") // 9:16 (portrait) ou 16:9 (paysage)
  duration     Int         @default(5) // Durée en secondes (5, 6, 7, ou 8)
  resolution   String      @default("1080p") // 720p, 1080p, ou 4k

  // Statut de génération (asynchrone)
  status       String      @default("pending") // pending | processing | completed | failed
  operationId  String?     // ID opération Vertex AI pour polling
  gcsUri       String?     // URI GCS où la vidéo est stockée (gs://bucket/path)
  errorMessage String?     // Message d'erreur si failed

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([status])
  @@index([sourceId])
}
